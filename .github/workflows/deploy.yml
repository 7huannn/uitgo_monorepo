name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  backend-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to ghcr
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        id: meta
        uses: docker/build-push-action@v6
        with:
          context: backend
          file: backend/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/uitgo-backend:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/uitgo-backend:latest

  flutter-build:
    runs-on: ubuntu-latest
    needs: backend-image
    strategy:
      matrix:
        app:
          - name: rider
            path: apps/rider_app
          - name: driver
            path: apps/driver_app
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        working-directory: ${{ matrix.app.path }}
        run: flutter pub get

      - name: Build APK
        working-directory: ${{ matrix.app.path }}
        run: flutter build apk --release --no-tree-shake-icons

      - name: Build web bundle
        working-directory: ${{ matrix.app.path }}
        run: flutter build web --release

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app.name }}-apk
          path: ${{ matrix.app.path }}/build/app/outputs/flutter-apk/*.apk

      - name: Upload web build
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app.name }}-web
          path: ${{ matrix.app.path }}/build/web

  flutter-ios:
    runs-on: macos-14
    needs: backend-image
    strategy:
      matrix:
        app:
          - name: rider
            path: apps/rider_app
          - name: driver
            path: apps/driver_app
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        working-directory: ${{ matrix.app.path }}
        run: flutter pub get

      - name: Build IPA (no codesign)
        working-directory: ${{ matrix.app.path }}
        run: flutter build ipa --no-codesign

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app.name }}-ipa
          path: ${{ matrix.app.path }}/build/ios/ipa/*.ipa

  staging-deploy:
    runs-on: ubuntu-latest
    needs:
      - backend-image
      - flutter-build
      - flutter-ios
    permissions:
      contents: read
      packages: read
    env:
      REGISTRY_OWNER: ${{ github.repository_owner }}
      IMAGE_TAG: ${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to ghcr
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # SECURITY: Require all secrets to be set, fail if missing
      - name: Validate required secrets
        run: |
          missing_secrets=()
          if [ -z "${{ secrets.STAGING_POSTGRES_USER }}" ]; then missing_secrets+=("STAGING_POSTGRES_USER"); fi
          if [ -z "${{ secrets.STAGING_POSTGRES_PASSWORD }}" ]; then missing_secrets+=("STAGING_POSTGRES_PASSWORD"); fi
          if [ -z "${{ secrets.STAGING_JWT_SECRET }}" ]; then missing_secrets+=("STAGING_JWT_SECRET"); fi
          if [ -z "${{ secrets.STAGING_REFRESH_TOKEN_ENCRYPTION_KEY }}" ]; then missing_secrets+=("STAGING_REFRESH_TOKEN_ENCRYPTION_KEY"); fi
          if [ -z "${{ secrets.STAGING_INTERNAL_API_KEY }}" ]; then missing_secrets+=("STAGING_INTERNAL_API_KEY"); fi
          
          if [ ${#missing_secrets[@]} -gt 0 ]; then
            echo "::error::Missing required secrets: ${missing_secrets[*]}"
            echo "Please configure these secrets in repository settings before deploying."
            exit 1
          fi
          echo "All required secrets are configured."

      - name: Prepare env file
        env:
          POSTGRES_USER: ${{ secrets.STAGING_POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.STAGING_POSTGRES_PASSWORD }}
          JWT_SECRET: ${{ secrets.STAGING_JWT_SECRET }}
          REFRESH_TOKEN_KEY: ${{ secrets.STAGING_REFRESH_TOKEN_ENCRYPTION_KEY }}
          INTERNAL_API_KEY: ${{ secrets.STAGING_INTERNAL_API_KEY }}
        run: |
          # SECURITY: Generate .env.staging from GitHub Secrets only (no fallbacks)
          cat > infra/staging/.env.staging << EOF
          POSTGRES_DB=uitgo
          POSTGRES_USER=${POSTGRES_USER}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          POSTGRES_DSN=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/uitgo?sslmode=disable
          PORT=8080
          JWT_SECRET=${JWT_SECRET}
          REFRESH_TOKEN_ENCRYPTION_KEY=${REFRESH_TOKEN_KEY}
          INTERNAL_API_KEY=${INTERNAL_API_KEY}
          CORS_ALLOWED_ORIGINS=https://staging.uitgo.app
          APP_ENV=staging
          LOG_FORMAT=json
          PROMETHEUS_ENABLED=true
          EOF

      - name: Validate staging compose stack
        working-directory: infra/staging
        run: |
          docker compose pull
          docker compose up -d
          docker compose ps
          docker compose logs api || true
          docker compose down -v
