# Seal Secrets Workflow
# This workflow seals secrets from GitHub Secrets and commits them to the repo
# Triggered manually or when secrets need rotation
name: Seal Secrets

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging

env:
  KUBESEAL_VERSION: '0.25.0'

jobs:
  seal-secrets:
    name: Seal Secrets for ${{ inputs.environment }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install kubeseal
        run: |
          wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v${KUBESEAL_VERSION}/kubeseal-${KUBESEAL_VERSION}-linux-amd64.tar.gz
          tar -xvzf kubeseal-${KUBESEAL_VERSION}-linux-amd64.tar.gz kubeseal
          sudo install -m 755 kubeseal /usr/local/bin/kubeseal

      - name: Create plain secrets from GitHub Secrets
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          REFRESH_TOKEN_ENCRYPTION_KEY: ${{ secrets.REFRESH_TOKEN_ENCRYPTION_KEY }}
          INTERNAL_API_KEY: ${{ secrets.INTERNAL_API_KEY }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          ADMIN_NAME: ${{ secrets.ADMIN_NAME }}
        run: |
          cat > /tmp/secrets.yaml << EOF
          apiVersion: v1
          kind: Secret
          metadata:
            name: uitgo-secrets
            namespace: uitgo
          type: Opaque
          stringData:
            POSTGRES_USER: "${POSTGRES_USER}"
            POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
            JWT_SECRET: "${JWT_SECRET}"
            REFRESH_TOKEN_ENCRYPTION_KEY: "${REFRESH_TOKEN_ENCRYPTION_KEY}"
            INTERNAL_API_KEY: "${INTERNAL_API_KEY}"
            ADMIN_EMAIL: "${ADMIN_EMAIL}"
            ADMIN_PASSWORD: "${ADMIN_PASSWORD}"
            ADMIN_NAME: "${ADMIN_NAME}"
          EOF

      - name: Fetch SealedSecrets public key
        env:
          SEALED_SECRETS_CERT: ${{ secrets.SEALED_SECRETS_CERT }}
        run: |
          # Use the public cert stored in GitHub Secrets
          # This cert is fetched from the cluster: kubeseal --fetch-cert
          echo "$SEALED_SECRETS_CERT" > /tmp/pub-sealed-secrets.pem

      - name: Seal secrets
        run: |
          kubeseal --cert /tmp/pub-sealed-secrets.pem \
            --format yaml \
            < /tmp/secrets.yaml \
            > k8s/overlays/${{ inputs.environment }}/sealed-secrets.yaml
          
          # Cleanup plain secrets immediately
          rm -f /tmp/secrets.yaml

      - name: Commit sealed secrets
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add k8s/overlays/${{ inputs.environment }}/sealed-secrets.yaml
          git diff --staged --quiet || git commit -m "chore(secrets): update sealed secrets for ${{ inputs.environment }} [skip ci]"
          git push
