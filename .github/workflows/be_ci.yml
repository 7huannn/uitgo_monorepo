name: Backend CI

on:
  pull_request:
    paths:
      - 'backend/**'
      - '.github/workflows/be_ci.yml'
      - '.golangci.yml'
  push:
    branches:
      - main
      - dev
    paths:
      - 'backend/**'
      - '.github/workflows/be_ci.yml'
      - '.golangci.yml'

jobs:
  go:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
        with:
          go-version: '1.25.3'

      - name: Cache Go modules
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
            backend/.gocache
          key: ${{ runner.os }}-go-${{ hashFiles('backend/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download modules
        working-directory: backend
        run: go mod download

      - name: Go vet
        working-directory: backend
        run: go vet ./...

      - name: Run tests with coverage
        working-directory: backend
        env:
          GOCACHE: ${{ github.workspace }}/backend/.gocache
        run: go test ./... -covermode=atomic -coverprofile=coverage.out

      - name: Ensure coverage >= 80%
        working-directory: backend
        run: |
          go tool cover -func=coverage.out | tee coverage.txt
          total=$(grep total coverage.txt | awk '{print substr($3, 1, length($3)-1)}')
          echo "Total coverage: $total%"
          python3 -c "import sys; sys.exit(0 if float('$total') >= 80.0 else 1)"

      - name: golangci-lint
        uses: golangci/golangci-lint-action@55c2c1448f86e01eaae002a5a3a9624417608d84 # v6
        with:
          version: v1.59.0
          working-directory: backend
          args: --timeout=5m
