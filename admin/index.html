<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>UITGo API Console</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f5f6fa;
        margin: 0;
        padding: 20px;
        color: #1f2933;
      }
      h1 {
        margin-bottom: 8px;
      }
      .card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        padding: 20px;
        margin-bottom: 20px;
      }
      label {
        font-weight: 600;
        display: block;
        margin-bottom: 6px;
      }
      input,
      select,
      button,
      textarea {
        font-family: inherit;
        font-size: 14px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #cbd2d9;
        margin-bottom: 12px;
        box-sizing: border-box;
      }
      button {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        color: #fff;
        border-radius: 12px;
        padding: 10px 16px;
        cursor: pointer;
        transition: transform 0.1s ease;
        margin-right: 8px;
        margin-bottom: 8px;
      }
      button:hover {
        transform: translateY(-1px);
      }
      button.secondary {
        background: #e3e8ee;
        color: #1f2933;
      }
      pre {
        background: #0f172a;
        color: #e5e7ff;
        padding: 16px;
        border-radius: 12px;
        max-height: 300px;
        overflow-y: auto;
        font-size: 13px;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .row > div {
        flex: 1;
        min-width: 200px;
      }
    </style>
  </head>
  <body>
    <h1>UITGo API Console</h1>
    <p>Quickly poke the backend trip API and realtime channel.</p>

    <div class="card">
      <label for="apiBase">API Base URL</label>
      <input id="apiBase" value="http://localhost:8080" />
      <button onclick="pingHealth()">GET /health</button>
      <button class="secondary" onclick="clearLog()">Clear log</button>
    </div>

    <div class="card">
      <h2>Authentication</h2>
      <div class="row">
        <div>
          <h3>Register</h3>
          <label for="registerName">Name</label>
          <input id="registerName" value="UIT Rider" />
          <label for="registerEmail">Email</label>
          <input id="registerEmail" value="rider@example.com" />
          <label for="registerPhone">Phone</label>
          <input id="registerPhone" value="0900000000" />
          <label for="registerPassword">Password</label>
          <input id="registerPassword" type="password" value="123456" />
          <button onclick="registerUser()">POST /auth/register</button>
        </div>
        <div>
          <h3>Login</h3>
          <label for="loginEmail">Email</label>
          <input id="loginEmail" value="rider@example.com" />
          <label for="loginPassword">Password</label>
          <input id="loginPassword" type="password" value="123456" />
          <button onclick="loginUser()">POST /auth/login</button>
          <button class="secondary" onclick="logout()">Logout</button>
          <p id="authStatus" style="margin-top: 12px; font-weight: 600"></p>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Create Trip</h2>
      <div class="row">
        <div>
          <label for="origin">Origin</label>
          <input id="origin" value="UIT Campus" />
        </div>
        <div>
          <label for="destination">Destination</label>
          <input id="destination" value="Dormitory" />
        </div>
        <div>
          <label for="serviceId">Service</label>
          <input id="serviceId" value="UIT-Bike" />
        </div>
      </div>
      <button onclick="createTrip()">POST /v1/trips</button>
    </div>

    <div class="card">
      <h2>Trip Operations</h2>
      <label for="tripId">Trip ID</label>
      <input id="tripId" placeholder="Paste trip id here" />
      <div class="row">
        <div>
          <button onclick="getTrip()">GET /v1/trips/:id</button>
        </div>
        <div>
          <label for="status">Status</label>
          <select id="status">
            <option value="requested">requested</option>
            <option value="accepted">accepted</option>
            <option value="arriving">arriving</option>
            <option value="in_ride">in_ride</option>
            <option value="completed">completed</option>
            <option value="cancelled">cancelled</option>
          </select>
          <button onclick="updateStatus()">PATCH status</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Realtime Channel</h2>
      <div class="row">
        <div>
          <label for="wsRole">Role</label>
          <select id="wsRole">
            <option value="rider">rider</option>
            <option value="driver">driver</option>
          </select>
        </div>
        <div>
          <label for="wsUserId">Override user id (optional)</label>
          <input id="wsUserId" value="demo-rider" />
        </div>
      </div>
      <button onclick="connectWs()">Connect WS</button>
      <button class="secondary" onclick="disconnectWs()">Disconnect</button>
      <div id="driverControls" style="display: none; margin-top: 12px">
        <h3>Driver tools</h3>
        <div class="row">
          <div>
            <label for="driverLat">Latitude</label>
            <input id="driverLat" value="10.8705" />
          </div>
          <div>
            <label for="driverLng">Longitude</label>
            <input id="driverLng" value="106.8032" />
          </div>
        </div>
        <button onclick="sendLocation()">Send location</button>
        <button onclick="sendStatus('arriving')">Set arriving</button>
        <button onclick="sendStatus('in_ride')">Set in_ride</button>
        <button onclick="sendStatus('completed')">Set completed</button>
      </div>
    </div>

    <div class="card">
      <h2>Log</h2>
      <pre id="log"></pre>
    </div>

    <script>
      const logEl = document.getElementById('log');
      let ws;

      let authToken = localStorage.getItem('uitgoToken') || '';
      let authEmail = localStorage.getItem('uitgoEmail') || '';
      let authUserId = localStorage.getItem('uitgoUserId') || '';

      function apiBase() {
        return document.getElementById('apiBase').value.trim();
      }

      function appendLog(message) {
        const timestamp = new Date().toLocaleTimeString();
        logEl.textContent += `[${timestamp}] ${message}\n`;
        logEl.scrollTop = logEl.scrollHeight;
      }

      function clearLog() {
        logEl.textContent = '';
      }

      function updateAuthStatus() {
        const statusEl = document.getElementById('authStatus');
        if (!statusEl) return;
        if (authToken) {
          statusEl.textContent = `Logged in as ${authEmail || 'unknown'} (id: ${
            authUserId || 'unknown'
          })`;
        } else {
          statusEl.textContent = 'Not logged in';
        }
      }

      function syncUserIdInputs(force = false) {
        const wsInput = document.getElementById('wsUserId');
        const defaultValue = authUserId || '';
        if (wsInput && (force || !wsInput.value)) {
          wsInput.value = defaultValue;
        }
      }

      function setAuth(data) {
        authToken = data?.token || '';
        authEmail = data?.email || '';
        authUserId = data?.id || '';
        if (authToken) {
          localStorage.setItem('uitgoToken', authToken);
          localStorage.setItem('uitgoEmail', authEmail);
          localStorage.setItem('uitgoUserId', authUserId);
        }
        updateAuthStatus();
        syncUserIdInputs(true);
      }

      function logout() {
        authToken = '';
        authEmail = '';
        authUserId = '';
        localStorage.removeItem('uitgoToken');
        localStorage.removeItem('uitgoEmail');
        localStorage.removeItem('uitgoUserId');
        updateAuthStatus();
        syncUserIdInputs(true);
        appendLog('üëã Logged out (token cleared)');
      }

      function authHeaders(base = {}) {
        const headers = { ...base };
        if (authToken) {
          headers.Authorization = `Bearer ${authToken}`;
        }
        return headers;
      }

      async function pingHealth() {
        try {
          const res = await fetch(`${apiBase()}/health`);
          appendLog(`GET /health ‚Üí ${res.status}`);
          appendLog(await res.text());
        } catch (err) {
          appendLog(`‚ùå /health error: ${err}`);
        }
      }

      async function registerUser() {
        const payload = {
          name: document.getElementById('registerName').value,
          email: document.getElementById('registerEmail').value,
          phone: document.getElementById('registerPhone').value,
          password: document.getElementById('registerPassword').value,
        };
        try {
          const res = await fetch(`${apiBase()}/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const text = await res.text();
          appendLog(`POST /auth/register ‚Üí ${res.status}`);
          appendLog(text);
          if (res.ok) {
            const data = safeJson(text);
            setAuth(data);
          }
        } catch (err) {
          appendLog(`‚ùå register error: ${err}`);
        }
      }

      async function loginUser() {
        const payload = {
          email: document.getElementById('loginEmail').value,
          password: document.getElementById('loginPassword').value,
        };
        try {
          const res = await fetch(`${apiBase()}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const text = await res.text();
          appendLog(`POST /auth/login ‚Üí ${res.status}`);
          appendLog(text);
          if (res.ok) {
            const data = safeJson(text);
            setAuth(data);
          }
        } catch (err) {
          appendLog(`‚ùå login error: ${err}`);
        }
      }

      async function createTrip() {
        const origin = document.getElementById('origin').value;
        const destination = document.getElementById('destination').value;
        const serviceId = document.getElementById('serviceId').value;
        try {
          const res = await fetch(`${apiBase()}/v1/trips`, {
            method: 'POST',
            headers: authHeaders({ 'Content-Type': 'application/json' }),
            body: JSON.stringify({
              originText: origin,
              destText: destination,
              serviceId,
            }),
          });
          const text = await res.text();
          appendLog(`POST /v1/trips ‚Üí ${res.status}`);
          appendLog(text);
          if (res.ok) {
            const payload = safeJson(text);
            if (payload?.id) {
              document.getElementById('tripId').value = payload.id;
            }
          }
        } catch (err) {
          appendLog(`‚ùå create trip error: ${err}`);
        }
      }

      async function getTrip() {
        const tripId = document.getElementById('tripId').value.trim();
        if (!tripId) {
          appendLog('‚ö†Ô∏è Trip id required');
          return;
        }
        try {
          const res = await fetch(`${apiBase()}/v1/trips/${tripId}`, {
            headers: authHeaders(),
          });
          appendLog(`GET /v1/trips/${tripId} ‚Üí ${res.status}`);
          appendLog(await res.text());
        } catch (err) {
          appendLog(`‚ùå get trip error: ${err}`);
        }
      }

      async function updateStatus() {
        const tripId = document.getElementById('tripId').value.trim();
        const status = document.getElementById('status').value;
        if (!tripId) {
          appendLog('‚ö†Ô∏è Trip id required');
          return;
        }
        try {
          const res = await fetch(`${apiBase()}/v1/trips/${tripId}/status`, {
            method: 'PATCH',
            headers: authHeaders({ 'Content-Type': 'application/json' }),
            body: JSON.stringify({ status }),
          });
          appendLog(`PATCH /v1/trips/${tripId}/status ‚Üí ${res.status}`);
          appendLog(await res.text());
        } catch (err) {
          appendLog(`‚ùå update status error: ${err}`);
        }
      }

      function wsUrl(tripId, role, { userId, token }) {
        const base = new URL(apiBase());
        base.protocol = base.protocol === 'https:' ? 'wss:' : 'ws:';
        base.pathname = `${base.pathname.replace(/\/$/, '')}/v1/trips/${tripId}/ws`;
        const params = new URLSearchParams({ role });
        if (userId) {
          params.set('userId', userId);
        }
        if (token) {
          params.set('accessToken', token);
        }
        base.search = params.toString();
        return base.toString();
      }

      function connectWs() {
        const tripId = document.getElementById('tripId').value.trim();
        if (!tripId) {
          appendLog('‚ö†Ô∏è Trip id required for WebSocket');
          return;
        }
        const role = document.getElementById('wsRole').value;
        const userId = document.getElementById('wsUserId').value.trim();

        if (ws) {
          ws.close();
        }

        const url = wsUrl(tripId, role, {
          userId: userId || authUserId,
          token: authToken,
        });
        appendLog(`üîå connecting to ${url}`);
        ws = new WebSocket(url);

        ws.onopen = () => {
          appendLog('‚úÖ WS connected');
          document.getElementById('driverControls').style.display =
            role === 'driver' ? 'block' : 'none';
        };
        ws.onmessage = (event) => {
          appendLog(`üì® ${event.data}`);
        };
        ws.onerror = (event) => {
          appendLog(`‚ùå WS error: ${event.message || event}`);
        };
        ws.onclose = () => {
          appendLog('üîå WS closed');
          document.getElementById('driverControls').style.display = 'none';
        };
      }

      function disconnectWs() {
        if (ws) {
          ws.close();
          ws = null;
        }
      }

      function sendLocation() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          appendLog('‚ö†Ô∏è WebSocket not connected');
          return;
        }
        const lat = parseFloat(document.getElementById('driverLat').value);
        const lng = parseFloat(document.getElementById('driverLng').value);
        ws.send(JSON.stringify({ type: 'location', lat, lng }));
        appendLog(`üì§ sent location ${lat}, ${lng}`);
      }

      function sendStatus(status) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          appendLog('‚ö†Ô∏è WebSocket not connected');
          return;
        }
        ws.send(JSON.stringify({ type: 'status', status }));
        appendLog(`üì§ sent status ${status}`);
      }

      function safeJson(text) {
        try {
          return JSON.parse(text);
        } catch (_) {
          return null;
        }
      }

      updateAuthStatus();
      syncUserIdInputs(true);
    </script>
  </body>
</html>
